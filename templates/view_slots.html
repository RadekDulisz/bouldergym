{% extends "base.html" %}

{% block title %}View Slots - Boulder Gym{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-orange-400">Book Your Climbing Session</h2>
    <p class="text-slate-400 mt-2">Select a date and time (requires a valid pass)</p>
</div>


<div class="flex justify-between items-center mb-8 bg-slate-800 border border-slate-700 rounded-xl p-6">
    <button onclick="previousWeek()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold transition">‚Üê Previous Week</button>
    <h3 class="text-2xl font-bold text-orange-400" id="weekDisplay"></h3>
    <button onclick="nextWeek()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold transition">Next Week ‚Üí</button>
</div>


<div id="calendarContainer" class="mb-8">
    
</div>


<div class="bg-slate-800 border border-slate-700 rounded-xl p-6 mb-8">
    <h3 class="text-lg font-bold text-orange-400 mb-4">Climbing Hours Available</h3>
    <div class="grid md:grid-cols-6 gap-3">
        <div class="text-center p-3 bg-slate-700/50 rounded-lg">
            <p class="text-sm text-slate-300">üåÖ</p>
            <p class="text-xs font-semibold text-slate-200">09:00-11:00</p>
        </div>
        <div class="text-center p-3 bg-slate-700/50 rounded-lg">
            <p class="text-sm text-slate-300">‚òÄÔ∏è</p>
            <p class="text-xs font-semibold text-slate-200">11:00-13:00</p>
        </div>
        <div class="text-center p-3 bg-slate-700/50 rounded-lg">
            <p class="text-sm text-slate-300">üåû</p>
            <p class="text-xs font-semibold text-slate-200">13:00-15:00</p>
        </div>
        <div class="text-center p-3 bg-slate-700/50 rounded-lg">
            <p class="text-sm text-slate-300">üå§Ô∏è</p>
            <p class="text-xs font-semibold text-slate-200">15:00-17:00</p>
        </div>
        <div class="text-center p-3 bg-slate-700/50 rounded-lg">
            <p class="text-sm text-slate-300">üåÜ</p>
            <p class="text-xs font-semibold text-slate-200">17:00-19:00</p>
        </div>
        <div class="text-center p-3 bg-slate-700/50 rounded-lg">
            <p class="text-sm text-slate-300">üåô</p>
            <p class="text-xs font-semibold text-slate-200">19:00-21:00</p>
        </div>
    </div>
</div>


<div class="grid md:grid-cols-2 gap-6">
    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
        <h4 class="text-lg font-bold text-orange-400 mb-3">Session Information</h4>
        <ul class="space-y-2 text-slate-300 text-sm">
            <li><strong>Duration:</strong> 2 hours per session</li>
            <li><strong>Max Capacity:</strong> 20 climbers per slot</li>
            <li><strong>Requirement:</strong> Valid pass required to book</li>
            <li><strong>Cancellation:</strong> Up to 24 hours before start</li>
        </ul>
    </div>
    
    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
        <h4 class="text-lg font-bold text-orange-400 mb-3">Legend</h4>
        <ul class="space-y-2 text-sm">
            <li class="flex items-center gap-2">
                <span class="w-3 h-3 bg-green-500 rounded"></span>
                <span class="text-slate-300">Spots Available - Click to Book</span>
            </li>
            <li class="flex items-center gap-2">
                <span class="w-3 h-3 bg-red-500 rounded"></span>
                <span class="text-slate-300">Fully Booked</span>
            </li>
        </ul>
    </div>
</div>

<script>
    // Slot data from backend
    const allSlots = {{ slots | tojson }};
    
    let weekOffset = 0;

    // Format a date as YYYY-MM-DD in local time (avoid UTC shift)
    function formatDateLocal(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }
    
    // Always get today's date dynamically
    function getToday() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today;
    }
    
    function getWeekStart(offset) {
        const today = getToday();
        const d = new Date(today);
        d.setDate(today.getDate() - today.getDay() + offset * 7);
        return d;
    }
    
    function getWeekEnd(offset) {
        const start = getWeekStart(offset);
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        return end;
    }
    
    function updateWeekDisplay() {
        const start = getWeekStart(weekOffset);
        const end = getWeekEnd(weekOffset);
        
        const options = { month: 'short', day: 'numeric' };
        const startStr = start.toLocaleDateString('en-US', options);
        const endStr = end.toLocaleDateString('en-US', options);
        document.getElementById('weekDisplay').textContent = startStr + ' - ' + endStr;
        
        renderCalendar();
    }
    
    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        container.innerHTML = '';
        
        const weekStart = getWeekStart(weekOffset);
        const weekEnd = getWeekEnd(weekOffset);
        
        // Create grid for 7 days
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-3';
        
        // Initialize day slots map
        const daySlots = {};
        
        // Filter slots for this week and organize by date
        allSlots.forEach(slot => {
            const slotDate = new Date(slot.date);
            slotDate.setHours(0, 0, 0, 0);
            
            if (slotDate >= weekStart && slotDate <= weekEnd) {
                const dateStr = formatDateLocal(slotDate);
                if (!daySlots[dateStr]) {
                    daySlots[dateStr] = [];
                }
                daySlots[dateStr].push(slot);
            }
        });
        
        // Create day cards for each day of the week
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + i);
            const dateStr = formatDateLocal(dayDate);
            
            const dayCard = document.createElement('div');
            dayCard.className = 'bg-slate-800 border border-slate-700 rounded-lg overflow-hidden hover:border-orange-500 transition';
            
            // Day header
            const header = document.createElement('div');
            header.className = 'bg-slate-700 px-4 py-3 border-b border-slate-600 text-center';
            header.innerHTML = `
                <p class="font-bold text-orange-400 text-sm">${dayDate.toLocaleDateString('en-US', {weekday: 'short'})}</p>
                <p class="text-lg font-bold">${dayDate.getDate()}</p>
                <p class="text-xs text-slate-400">${dayDate.toLocaleDateString('en-US', {month: 'short'})}</p>
            `;
            dayCard.appendChild(header);
            
            // Slots container
            const slotsDiv = document.createElement('div');
            slotsDiv.className = 'p-3 space-y-2';
            
            if (daySlots[dateStr]) {
                daySlots[dateStr].forEach(slot => {
                    const slotBtn = document.createElement('form');
                    slotBtn.method = 'POST';
                    slotBtn.action = '{{ url_for("book_entry") }}';
                    
                    const isAvailable = slot.available;
                    const btnClass = isAvailable 
                        ? 'w-full text-left p-2 rounded border border-slate-600 hover:bg-slate-700 hover:border-orange-400 transition cursor-pointer'
                        : 'w-full text-left p-2 rounded border border-slate-700 bg-slate-700/50 opacity-50 cursor-not-allowed';
                    
                    slotBtn.innerHTML = `
                        <input type="hidden" name="date" value="${dateStr}">
                        <input type="hidden" name="time_slot" value="${slot.time_slot}">
                        <button type="submit" ${isAvailable ? '' : 'disabled'} class="${btnClass}">
                            <p class="text-xs font-semibold text-slate-300">${slot.time_slot}</p>
                            <p class="text-xs ${isAvailable ? 'text-green-400' : 'text-red-400'} mt-1">
                                ${isAvailable ? slot.spots_left + ' spots' : 'Fully Booked'}
                            </p>
                        </button>
                    `;
                    slotsDiv.appendChild(slotBtn);
                });
            } else {
                const empty = document.createElement('p');
                empty.className = 'text-xs text-slate-500 text-center py-2';
                empty.textContent = 'No slots';
                slotsDiv.appendChild(empty);
            }
            
            dayCard.appendChild(slotsDiv);
            grid.appendChild(dayCard);
        }
        
        container.appendChild(grid);
    }
    
    function previousWeek() {
        weekOffset--;
        updateWeekDisplay();
    }
    
    function nextWeek() {
        weekOffset++;
        updateWeekDisplay();
    }
    
    // Initialize
    updateWeekDisplay();
</script>
{% endblock %}

